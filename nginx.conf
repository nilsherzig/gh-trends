# Define a shared memory zone for caching API responses.
# keys_zone=api_cache:10m -> 10MB zone named api_cache
# max_size=10g -> Cache size up to 10GB on disk
# inactive=60m -> Evict items not accessed for 60 minutes
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m max_size=10g inactive=60m use_temp_path=off;

# Define a server block for our application
server {
    # Listen on the default HTTP port 80
    listen 80;
    listen [::]:80;

    # Set the root directory where our files are served from
    root /usr/share/nginx/html;

    # Specify the default file to serve
    index index.html;

    # Define how to handle requests
    location / {
        # This is important for single-page apps. It tries to find a file
        # that matches the request URI, and if it fails, it falls back
        # to serving /index.html. This allows your hash-based routing to work.
        try_files $uri $uri/ /index.html;
    }

    # Location to proxy and cache the languages.json file
    location = /data/languages.json {
        proxy_pass https://cdn.jsdelivr.net/gh/isboyjc/github-trending-api/data/languages.json;
        proxy_cache api_cache; # Use the cache zone defined above
        proxy_cache_valid 200 6h; # Cache successful responses for 6 hours
        proxy_cache_lock on; # Prevent simultaneous requests for the same new item
        add_header X-Proxy-Cache $upstream_cache_status; # Add a status header for debugging
    }

    # Location to proxy and cache the trending repository data
    # This will match requests like /data/daily/all.json
    location /data/ {
        # The part of the URL after /data/ will be appended to the proxy_pass URL.
        proxy_pass https://raw.githubusercontent.com/isboyjc/github-trending-api/main/data/;
        proxy_cache api_cache;
        proxy_cache_valid 200 30m; # Cache successful responses for 30 minutes
        proxy_cache_lock on;
        add_header X-Proxy-Cache $upstream_cache_status;
    }
}
